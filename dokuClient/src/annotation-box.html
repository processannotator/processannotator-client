<link rel="import" href="../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">
<link href="../bower_components/iron-icons/iron-icons.html" rel="import">

<dom-module id="annotation-box">

	<template>


		<style>

			:host {
				display: block;
				position: relative;
				box-sizing: border-box;
				width: auto;
				height: auto;
			}

			paper-button {
				border-radius: 0px;
			}


			#container {
				display: flex;
				flex-direction: column;
				background-color: rgb(7, 20, 26);
				transition: background-color 0.3s ease-in-out;
				height: auto;
				min-height: 7em;
				max-height: 20em;
				/*margin-bottom: 1em;*/
				cursor: pointer;
			}

			#container:hover {
				background-color: rgba(12, 38, 50, 1);

				/*-webkit-transform:rotateY(50deg);*/
				/*-webkit-transform:rotateZ(25deg);*/
			}

			#header,
			#main {
				padding: 0.25em;
				/*min-width: 100%;
				width: 100%;*/
			}

			#container, #tagsAndStatus {
				border-top: 1px solid rgb(21, 68, 89);
			}

			#header {
				padding: 0;
				flex: 1 0 0;
				display: flex;
				flex-direction: row;
				font-size: 1.2em;
				color: #4A4A4A;
				min-height: 1.5em;
				background-color: rgba(0,0,0,0);
			}

			#header > #letters_id {
				text-align: center;
				min-height: 1.5em;
				padding-top: 0.1em;
				padding-bottom: 0.1em;
				min-width: 1.5em;
				background: #9B9B9B;
				color: white;
				font-family: "SourceSansPro-Semibold";
			}

			#header > #profile_name {
				min-height: 100%;
				padding-left: 0.5em;
				padding-top: 0.1em;
				padding-bottom: 0.1em;
			}

			#main {
				flex: 4 0 0;
				background-color: rgba(0,0,0,0);
				color: rgb(197, 227, 241);
				font-size: 0.8em;
			}

			#tagsAndStatus {
				flex: 1.5 0 0;
				display: flex;
				flex-direction: row;
				justify-content: space-around;
				color: rgb(197, 227, 241);
				font-size: 0.75em;
				min-height: 2em;
			}

			#tagsAndStatus > * {
				flex: 1;
				margin: 0;
			}

			#tagsAndStatus > paper-button:not(:last-of-type) {
				border-right: 1px solid rgb(21, 68, 89);
			}


			#statusList {
				padding: 0;
			}

			.comment {
				color: rgb(5, 73, 105);
			}

			.task {
				color: yellow;
			}

			.problem {
				color: orange;
			}

			paper-item {
				font-size: 0.8em;
			}

			.dropdown-content > paper-item {
				background-color:  rgb(7, 20, 26);
			}


			#footer {
				flex: 1 0 0;
				text-align: center;
				vertical-align: bottom;
				color: #303030;
				/*background-color: #696565;*/
			}
			#creationDate {
					opacity: 0.65;
					font-size: 0.85em;
			}

			#annotationText {
				cursor: text;
				width: 100%;
				max-height: auto;
				background-color: none;
				border: none;
 				box-shadow: none;
				outline: none;
			}
			#annotationText:focus {
			}


		</style>

		<div id="container" on-tap="tap">

			<div id="header">
				<div id="letters_id">[[computeNameLetters(annotation.creatorProfile.prename, annotation.creatorProfile.surname)]]</div>
				<div id="profile_name">
					<span>[[annotation.creatorProfile.prename]]</span>
					<span>[[annotation.creatorProfile.surname]]</span>
				</div>
			</div>

			<div id="main">
				<span id="creationDate">[[annotation.creationDate]]</span>
				<br>
				<iron-autogrow-textarea bind-value="{{annotation.description}}" on-input="keydown" placeholder="enter textâ€¦" id="annotationText"></iron-autogrow-textarea>
			</div>
			<div id="tagsAndStatus">
				<paper-button id="tags">Tags</paper-button>
				<paper-button on-tap="deleteAnnotation" id="delete">Delete</paper-button>
				<paper-button class$="[[annotation.status]]" id="status" dropdown-trigger on-tap="openStatusDropdown">[[annotation.status]]</paper-button>
				<iron-dropdown always-on-top auto-fit-on-attach id="statusDropdown" horizontal-align="right" vertical-align="top">
					<paper-listbox on-tap="clickedStatusList" attr-for-selected="label" selected="{{annotation.status}}" fallback-selection="[[annotation.status]]" id="statusList" on-iron-select="statusChanged" class="dropdown-content">
						<paper-item class="comment" label="comment">COMMENT</paper-item>
						<paper-item class="task" label="task">TASK</paper-item>
					<paper-item class="problem" label="problem">PROBLEM</paper-item>
					</paper-listbox>
				</iron-dropdown>
			</div>

		</div>

	</template>

	<script>
		Polymer({
			is: "annotation-box",
			listeners: {
				mouseenter: 'mouseEnter'
			},
			properties: {
				annotation: {
					type: Object,
					observer: "_annotationChanged",
					notify: true
				}
			},
			attached: function () {
				// HACK: this should work without $$('input')
				// see: https://github.com/PolymerElements/iron-autogrow-textarea/issues/92

				this.$.annotationText.$$('textarea').focus();
				if(this.annotation.description === '') {

				}
			},
			_annotationChanged: function() {
				this.$.letters_id.style.backgroundColor = this.annotation.statusColor;
				this.$.header.style.color = this.annotation.statusColor;
			},
			keydown: function (event) {
				this.editAnnotation({text: this.annotation.description, temporary: true});
				if (event.defaultPrevented)
					return; // Should do nothing if the key event was already consumed.


				// Reatime inform app about keypress, to update 3D-labels especially, before
				// DB update kicks in (editAnnotation)


				clearTimeout(this.editTimeOut);
				this.editTimeOut = setTimeout(() => {
					this.editAnnotation({text: this.annotation.description});
				}, 5000);
			},

			editAnnotation: function({text, temporary=false}) {
				this.annotation.description = text;
				this.fire('annotation-edited-by-user', {temporary, newAnnotation: this.annotation, elem: this});
			},
			deleteAnnotation(event) {
				this.fire('annotation-deleted-by-user', {annotation: this.annotation, elem: this});
				event.preventDefault();
				event.stopPropagation();
			},
			computeNameLetters: function (prename, surname) {
				return prename[0] + surname[0];
			},
			tap: function () {
				this.fire('annotation-box-mouse-enter', this.annotation);
			},
			clickedStatusList: function (e) {
				this.fire('annotation-edited-by-user', {newAnnotation: this.annotation, elem: this});
			},
			statusChanged: function (e) {
				this.$.statusDropdown.close();
				console.log('status changed...');

			},
			openStatusDropdown: function (e) {
					this.$.statusDropdown.toggle();
			}
		})
	</script>

</dom-module>
